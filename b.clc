
interface JITTestInterface
{
    def method(value:int):int;
    def method2();
}

class JITTestClassA
{
    value:int;

    def initialize() {
        self.value = 111;
    }

    def initialize(value:int) {
        self.value = value;
    }

    def method(value:int):int {
        return value;
    }
    def method2() throws Exception {
        throw new Exception("exception");
    }

    def classMethod(): static int {
        return 1;
    }
    def classMethod(a:int, b:int):static int {
        return a + b;
    }

    def getValue(): int {
        return self.value;
    }

    def runException(): static { 
        throw new Exception("AAA");
    }

    def method_byte(value:byte): static bool {
        return true;
    }

    def aaaa():static int {
        return 123;
    }

    def method10(a:int, b: int, block_:lambda(int,int):int): int {
        return block_(a,b);
    }
}

class JITTest 
{
    field1: int;
    len:int;

    def initialize() {
        self.field1 = 123;
        self.len = 10;
    }

    def run(): int {
        return 3+1;
    }

    def run2(): String {
        return "ABC";
    }

    def run3(): {
        System.println("HELLO WORLD");
    }

    def run4(): int {
        return JITTestClassA.classMethod() + 3;
    }

    def run5(): int {
        return JITTestClassA.classMethod(1, 2);
    }

    def run6(): double {
        return System.strtod("123.1");
    }

    def run7():  int {
        a:int = 123;
        return a + 1;
    }

    def method(): String {
        return "ABC";
    }

    def run8(): String {
        return self.method().append("DEF");
    }

    def run9(): JITTestClassA {
        return new JITTestClassA(123);
    }

    def run10(): int {
        throw new Exception("Exception");
        return 1;
    }

    def method2() throws Exception {
        throw new Exception("exception");
    }

    def run11(): {
        print("jit test11...");
        try {
            self.method2();
        }
        catch(e:Exception) {
            println("OK");
        }
    }

    def run11_5() {
        a:int = 1;
        b:int = a;
    }

    def run12():  bool {
        a:int = 1;
        b:bool = a == 1;

        return b;
    }

    def run13(): int {
        a:int = 1;

        if(a == 1) {
            return 2;
        }
        else {
            return 3;
        }

        return a;
    }

    def run14():  int {
        a:int = 0;

        while(true) {
            a++;

            if(a == 1) {
                break;
            }
        }

        return a;
    }

    def run15():  int {
        a:int = 0;

        i:int = 0;
        while(i<3) {
            a++;
            i++;
        }

        return a;
    }

    def run16(): int {
        a:int = 0;

        for(i:int = 0; i<3; i++) {
            a++;
        }

        return a;
    }

    def run17():  int {
        a:int = 1;
        a.to_bool && ((a = 2).to_bool);
        
        return a;
    }

    def run18():  int {
        a:int = 1;
        a.to_bool || ((a = 2).to_bool);

        return a;
    }

    def run19():  int {
        return self.field1;
    }

    def run20(): regex {
        return /./;
    }

    def run21():  bool {
        return /./ == /./;
    }

    def run22():  bool {
        return /../ != /./;
    }

    def run23():  byte {
        a:byte = 1y;
        b:byte = 2y;

        return a + b;
    }
    def run24():  byte {
        a:byte = 1;

        return a;
    }
    def run25(): int {
        a:ubyte = 123uy;
        b:ubyte = 123uy;

        return a + b;
    }
    def run26():  int {
        a:byte = 123y;
        b:byte = 23y;

        return a - b;
    }
    def run27():  byte {
        a:byte = 1;
        b:byte = 2;

        return a * b;
    }
    def run28(): byte {
        a:byte = 9;
        b:byte = 3;

        return a / b;
    }
    def run29():  byte {
        a:byte = 5;
        b:byte = 3;

        return a % b;
    }
    def run30():  byte {
        return 1y << 1y;
    }
    def run31():  byte {
        return 2y >> 1y;
    }
    def run32():  byte {
        return 011y & 01y;
    }
    def run33():  byte {
        return 0x01y | 0x02y;
    }
    def run34():  byte {
        return 0x07y ^ 0x01y;
    }
    def run35():  long {
        return 1l + 2l;
    }
    def run36():  byte {
        return ~0x01y;
    }
    def run37():  int {
        return ~0x01;
    }
    def run38():  float {
        return 1.1f + 1.1f;
    }
    def run39():  float {
        return 1.1f * 2.0f;
    }
    def run40():  double {
        return 2.0 + 2.0;
    }
    def run41(): bool {
        return 1y < 2y;
    }
    def run42():  bool {
        return 1uy < 2uy;
    }
    def run43():  bool {
        return 1l < 2l;
    }
    def run44():  bool {
        return 100000ul < 200000000000ul;
    }
    def run45():  bool {
        return 1.1f < 2.2f;
    }
    def run46():  bool {
        return 1.1 < 2.2;
    }
    def run47():  bool {
        return 'a' < 'b';
    }
    def run48():  bool {
        return !false;
    }
    def run49():  bool {
        return !true;
    }
    def run49_5(a:pointer):bool {
        a++;
        a+=2ul;

        return true;
    }
    def run50():  String {
        a:String = "ABC";

        return a.className();
    }
    def run51():  bool {
        a:String = "ABC";

        return a.className().equals("String");
    }
    def run52():  bool {
        a:String = "ABC";
        return a implements Object;
    }
    def run53(): int {
        interface:JITTestInterface = new JITTestClassA();

        return interface.method(123) + 123;
    }

    def run53_5() throws Exception {
        interface:JITTestInterface = new JITTestClassA();

        interface.method2();
    }

    def run54():  {
        ls("-al", "src/main.c");
    }

    def run55(x:int, y:int, block_:lambda(int,int):int):  int {
        return block_(x, y);
    }

    def run56():  {
        self.field1 = 777;
    }
    def run57():  int {
        return self.field1;
    }

    classField1: static int;

    def run58():  int {
        return JITTest.classField1;
    }

    def run59(): int {
        JITTest.classField1 = 777;
        return JITTest.classField1;
    }

    def run60():  int {
        a:int = 123;
        b:pointer = &a;
        b->int = 245;
        return a;
    }

    def run61():  long {
        a:long = 123l;
        b:pointer = &a;
        b->long = 245l;
        return a;
    }

    def run62():  double {
        a:double = 123.1;
        b:pointer = &a;
        b->double = 245.1;
        return a;
    }
    def run63():  int {
        a:int[] = new int[5]();

        a[1] = 111;
        a[2] = 222;

        return a.length;
    }
    def run64():  int {
        a:int[] = new int[5]();

        a[1] = 111;
        a[2] = 222;

        return a[1];
    }
    def run65():  char {
        return 'a'.to_upper;
    }
    def run66():  char {
        return 'A'.to_lower;
    }
    def run67():  bool {
        return /aaa/g.global;
    }
    def run68():  bool {
        return /aaa/.global;
    }
    def run69():  bool {
        return /aaa/i.ignoreCase;
    }
    def run70():  bool {
        return /aaa/.ignoreCase;
    }
    def run70_5(): int[] {
        return { 1, 2, 3 };
    }
    def run70_7(): Array<Integer> {
        return array { 1, 2, 3 };
    }
    def run71():  EqualableArray<Integer> {
        return equalable_array { 1,2,3 };
    }
    def run71_1(): List<Integer> {
        return list { 1, 2, 3 };
    }
    def run71_2(): EqualableList<Integer> {
        return equalable_list { 1, 2, 3 };
    }
    def run71_3(): Tuple2 <Integer, String> {
        return tuple { 1, "ABC" }
    }
    def run71_4(): Hash<String, Integer> {
        return hash { "ABC":1, "DEF":2 }
    }
    def run72():  lambda(int,int):int {
        return lambda(x:int, y:int):int { return x + y; };
    }
    def run72_5(): int {
        a :JITTestClassA = new JITTestClassA();
        a.value = 123;

        b:pointer = &a.value;

        b->int = 234;

        return a.value;
    }
    def run72_6(): int {
        a :int = 123;

        b:pointer = &a;

        return b->int;
    }
    def run72_7(): double {
        a :double = 123.1;

        b:pointer = &a;

        return b->double;
    }
    def run72_8(): float {
        a :float = 123.1f;

        b:pointer = &a;

        return b->float;
    }
    def run72_9(): long {
        a :long = 123l;

        b:pointer = &a;

        return b->long;
    }
    def run72_a(): byte {
        a :byte = 123y;

        b:pointer = &a;

        return b->byte;
    }
    def run73():  Integer {
        return 12y.toInteger;
    }
    def run74():  Integer {
        return 123l.toInteger;
    }
    def run75():  Integer {
        return 123.1f.toInteger;
    }
    def run76():  Integer {
        return 123.1.toInteger;
    }
    def run77():  Integer {
        return 'A'.toInteger;
    }
    def run78():  Integer {
        return true.toInteger;
    }
    def run78_1(): UInteger {
        return 123.toUInteger;
    }
    def run78_2(): UInteger {
        return 123.1.toUInteger;
    }
    def run78_3():  Integer {
        return -123.toInteger;
    }
    def run79(): Byte {
        return 123.toByte;
    }
    def run80(): Byte {
        return 123.1.toByte;
    }
    def run80_1(): Byte {
        return -123.toByte;
    }
    def run81(): UByte {
        return 123.toUByte;
    }
    def run82(): UByte {
        return 123.1.toUByte;
    }
    def run82_1(): Short {
        return 123.toShort;
    }
    def run82_2(): Short {
        return 123.1.toShort;
    }
    def run82_3(): UShort {
        return 123.toUShort;
    }
    def run82_4(): UShort {
        return 123.1.toUShort;
    }
    def run82_5(): Short {
        return -123u.toShort;
    }
    def run83():  ULong {
        return 123.toULong;
    }
    def run84():  Long {
        return 123456.toLong;
    }
    def run85():  Float {
        return 123.toFloat;
    }
    def run86():  Float {
        return 123.1f.toFloat;
    }
    def run87():  Float {
        return 123.1.toFloat;
    }
    def run87_1():  Float {
        return 123u.toFloat;
    }
    def run87_2():  Float {
        return -123.toFloat;
    }
    def run88():  Double {
        return 123.toDouble;
    }
    def run89():  Double {
        return 123.1f.toDouble;
    }
    def run90():  Double {
        return 123.1.toDouble;
    }
    def run90_1(): Double {
        return 123u.toDouble;
    }
    def run90_2(): Double {
        return -123.toDouble;
    }
    def run91(p:pointer): Pointer {
        return p.toPointer;
    }
    def run92(): Bool {
        return 1.1.toBool;
    }
    def run92_1(): Char {
        return 65.toChar;
    }
    def run92_2(): Char {
        return 65.0.toChar;
    }
    def run93_1(): String {
        return 123.toString;
    }
    def run93_2(): String {
        return 123l.toString;
    }
    def run93_3(): String {
        return 123y.toString;
    }
    def run93_4(): String {
        return 123ul.toString;
    }
    def run93_5(): String {
        return 123uy.toString;
    }
    def run93_6(): String {
        return -123.toString;
    }
    def run93_7(): String {
        return 123.1.toString;
    }
    def run93_8(): String {
        return 123.1f.toString;
    }
    def run93(): String {
        return 1.1.toString;
    }
    def run94():  String {
        return 123.toString;
    }
    def run95():  String {
        return 'a'.toString;
    }
    def run95_1():  String {
        return /a/.toString;
    }
    def run95_2():  String {
        return true.toString;
    }
    def run95_3():  String {
        return false.toString;
    }
    def run95_4(p:pointer):  String {
        return p.toString;
    }
    def run95_5() : int {
        return 123y.to_int;
    }
    def run95_6() : int {
        return 123l.to_int;
    }
    def run95_7() : int {
        return 123.1.to_int;
    }
    def run95_8() : byte {
        return 123.1.to_long;
    }
    def run95_9() : short {
        return 123.1.to_long;
    }
    def run95_10() : long {
        return 123y.to_long;
    }
    def run95_11() : byte {
        return 123u.to_long;
    }
    def run95_12() : byte {
        return 123.1.to_byte;
    }
    def run95_13() : byte {
        return 123s.to_byte;
    }
    def run95_14() : double {
        return 123l.to_double;
    }
    def run95_15() : float {
        return 123.to_float;
    }
    def run95_16() : float {
        return 123.1.to_float;
    }
    def run95_17() : float {
        return 123u.to_float;
    }
    def run95_18() : double {
        return 123.to_double;
    }
    def run95_19() : double {
        return 123.1f.to_double;
    }
    def run95_20() : double {
        return 123u.to_double;
    }
    def run96():  int {
        a:Integer = new Integer(123);
        return a;
    }
    def run96_1(): byte {
        a:Integer = new Integer(123);

        return a;
    }
    def run96_2(): float {
        a:Integer = new Integer(123);

        return a;
    }
    def run96_3(): double {
        a:Integer = new Integer(123);

        return a;
    }
    def run96_4(): byte {
        a:Integer = new Integer(-123);

        return a;
    }
    def run96_5(): double {
        a:Integer = new Integer(-123);

        return a;
    }
    def run96_6(): double {
        a:UInteger = new UInteger(123);

        return a;
    }
    def run96_7(): byte {
        a:UInteger = new UInteger(123);

        return a;
    }
    def run97():  long {
        a:Integer = new Integer(123);
        return a;
    }
    def run98():  float {
        a:Integer = new Integer(123);
        return a;
    }
    def run98_1(): byte {
        a:Byte = new Byte(123);
        return a;
    }
    def run98_2(): int {
        a:Byte = new Byte(123);
        return a;
    }
    def run98_3(): float {
        a:Byte = new Byte(123);
        return a;
    }
    def run98_4(): long {
        a:Byte = new Byte(123);
        return a;
    }
    def run98_5(): long {
        a:UByte = new UByte(123);
        return a;
    }
    def run98_6(): long {
        a:Byte = new Byte(-1);
        return a;
    }
    def run98_7(): double {
        a:UByte = new UByte(123);
        return a;
    }
    def run98_8(): double {
        a :Short = new Short(123);
        return a;
    }
    def run98_9(): byte {
        a :Short = new Short(123);
        return a;
    }
    def run98_10(): int {
        a :Short = new Short(123);
        return a;
    }
    def run98_11(): short {
        a :Short = new Short(-1);
        return a;
    }
    def run98_12(): byte {
        a :Short = new Short(-1);
        return a;
    }
    def run98_13(): long {
        a :Long = new Long(123);
        return a;
    }
    def run98_14(): byte {
        a :Long = new Long(123);
        return a;
    }
    def run98_15(): double {
        a :Long = new Long(123);
        return a;
    }
    def run98_16(): double {
        a :Long = new Long(-123);
        return a;
    }
    def run98_17(): byte {
        a :Long = new Long(-123);
        return a;
    }
    def run98_18(): byte {
        a :Char = new Char('A');
        return a;
    }
    def run98_19(): int {
        a :Char = new Char('A');
        return a;
    }
    def run99():  int {
        return 2.1f;
    }
    def run99_1(): long {
        #a:float = 2.1f;
        #axyz: Float = new Float(a);
        axyz: Float = new Float(2.1f);
        return axyz;
    }
    def run99_2(): double {
        a: Float = new Float(2.1f);
        return a;
    }
    def run99_3(): int {
        a: Float = new Float(2.1f);
        return a;
    }
    def run99_4(): double {
        a :Double = new Double(2.1);
        return a;
    }
    def run99_5(): int {
        a :Double = new Double(2.1);
        return a;
    }
    def run100():  float {
        return 2y;
    }
    def run101():  byte {
        return 2l;
    }
    def run102():  long {
        return 2y;
    }
    def run103():  bool {
        if(true) {
            if(false) {
                return false;
            }
            elif(false) {
                return false;
            }
            elif(false) {
                return false;
            }
            elif(true) {
                return true;
            }
            else {
                return false;
            }
        }
        elif(false) {
            return false;
        }
        else {
            return false;
        }

        return false;
    }
    def run104(block_:lambda(int)) {
        for(i:int = 0; i<3; i++) {
            block_(123);
        }
    }
    def run105() {
        a:Array<Integer> = array { 1, 2, 3 };
        a.each(lambda(n:Integer) {
            n.toString().println();
        });
    }
    def run106(): int {
        a:bool = false;
        n:int = 123;
        m:int = 123;
        if(a || n == m) {
            return 123;
        }
        else {
            return 245;
        }
    }
    def callingMethod(method_name:String, params:Array<Object>, num_method_chains:int, max_method_chains:int) : static Command throws Exception 
    {
        params2:List<String> = new List<String>();
        controlling_terminal_flag:bool = false;
        getting_stderr_flag:bool = false;
        
        params.each(closure(item:Object) {
            if(item.className().equals("String")) {
                str:String = item.toAnonymous();
                if(str.equals("--controlling-terminal")) {
                    controlling_terminal_flag = true;
                }
                elif(str.equals("--getting-stderr")) {
                    getting_stderr_flag = true;
                }
                else {
                    params2.add(str);
                }
            }
            elif(item.className().equals("List")) {
                list_:List<Object> = item.toAnonymous();

                list_.each(closure(item2:Object) {
                    if(item2.className().equals("String")) {
                        params2.add(item2.toAnonymous());
                    }
                });
            }
            elif(item.className().equals("EqualableList")) {
                list_:EqualableList<IEqualable> = item.toAnonymous();

                list_.each(closure(item2:IEqualable) {
                    if(item2.className().equals("String")) {
                        params2.add(item2.toAnonymous());
                    }
                });
            }
            elif(item.className().equals("SortableList")) {
                list_:SortableList<ISortable> = item.toAnonymous();

                list_.each(closure(item2:ISortable) {
                    if(item2.className().equals("String")) {
                        params2.add(item2.toAnonymous());
                    }
                });
            }
            elif(item.className().equals("Array")) {
                array_:Array<Object> = item.toAnonymous();

                array_.each(closure(item2:Object) {
                    if(item2.className().equals("String")) {
                        params2.add(item2.toAnonymous());
                    }
                });
            }
            elif(item.className().equals("EqualableArray")) {
                array_:EqualableArray<IEqualable> = item.toAnonymous();

                array_.each(closure(item2:IEqualable) {
                    if(item2.className().equals("String")) {
                        params2.add(item2.toAnonymous());
                    }
                });
            }
            elif(item.className().equals("SortableArray")) {
                array_:SortableArray<ISortable> = item.toAnonymous();

                array_.each(closure(item2:ISortable) {
                    if(item2.className().equals("String")) {
                        params2.add(item2.toAnonymous());
                    }
                });
            }
        });

        if(getting_stderr_flag) {
            str:String = null;
            #return Command.executeCommandWithGettingStderr(method_name, params2, str);
        }
        elif(controlling_terminal_flag || (num_method_chains == max_method_chains-1 && Command.controllingTerminalPrograms.indexOf(method_name) != -1)) 
        {
            a:int = 123;
            a.toString.println();
            #return Command.executeCommandWithControllingTerminal(method_name, params2);
        }
        else {
            b:int = 123;
            b.toString.println();
            #str:String = null;
            #return Command.executeCommand(method_name, params2, str);
        }
        return new Command("AAA", 0);
    }
    def run108(): bool {
        a:String = "ABC";
        result:String = new String(a.size);

        i:int =1;
        result.buffer[i] = a.buffer[a.len-i-1];

        return true;
    }
    def run108_1(): String {
        a:String = "ABC";
        result:String = new String(a.size);

        for(i:int = 0; i<a.len; i++) {
            result.buffer[i] = a.buffer[a.len-i-1];
        }
        result.buffer[i] = '\0';

        result.len = a.len;

        return result;
    }
    def run109(index:int, str:String):String {
        a:String = "ABC";

        len:int = str.length();

        new_size:int = (a.len + len + 1) * 2 + 1;
        new_buffer:char[] = new char[new_size];

        for(i:int = 0; i<index; i++) {
            new_buffer[i] = a.buffer[i];
        }
        for(i=0; i<len; i++) {
            new_buffer[i+index] = str.buffer[i];
        }
        for(i=index; i<a.len; i++) {
            new_buffer[i+len] = a.buffer[i];
        }

        new_buffer[i+len] = '\0';

        a.buffer = new_buffer;
        a.size = new_size;

        a.len += len;

        return a;
    }
    def run110(): char {
        c:char = 'B';

        p:pointer = &c;

        return p->char;
    }
    def run111(): char {
        c:char = 'A';

        p:pointer = &c;

        p->char = 'B';

        return c;
    }
    def run112(): int {
        println("HELLO JIT with mixin-layers");
        return 100;
    }
    def run112(): int {
        inherit();
        return 101;
    }
    def run113(): bool {
        if(false || false && true) {
            return false;
        }
        else {
            return true;
        }
    }
    def run114(): bool {
        regex_result:int = 1;
        group_strings:Array<String> = null;

        if(regex_result == 1 || group_strings.identifyWith(null) && regex_result > 0) {
            return true;
        }
        else {
            return false;
        }
    }
    def run115(): bool {
        regex_result:int = 1;
        group_strings:Array<String> = new Array<String>();

        if(regex_result == 1 || group_strings.identifyWith(null) && regex_result > 0) {
            return true;
        }
        else {
            return false;
        }
    }
    def run116(): bool {
        regex_result:int = 2;
        group_strings:Array<String> = null;

        if(regex_result == 1 || group_strings.identifyWith(null) && regex_result > 0) {
            return true;
        }
        else {
            return false;
        }
    }
    def run116_5(): bool {
        if(false || false && true) {
            return false;
        }
        else {
            return true;
        }
    }
    def run116_6(): bool {
        a:int = 0;
        b:int = 0;
        (a = 1).to_bool || (b = 2).to_bool;

        return a == 1 && b == 0;
        
    }
    def run116_7(): bool {
        a:int = 0;
        b:int = 0;
        c:int = 0;
        (a = 0).to_bool || (b = 2).to_bool && (c = 3).to_bool;

        return a == 0 && b == 0;
        
    }
    def run116_8(): bool {
        return false;
    }
    def run116_9():bool {
        a:JITTest = new JITTest();
        #return false || "AAA".equals("BAA") && true;
        return false || a.identifyWith(null) && true;
    }
    def run117(): bool {
        regex_result:int = 3;
        group_strings:Array<String> = new Array<String>();

        #if(regex_result == 1 || false && regex_result > 0) {
        if(regex_result == 1 || group_strings.identifyWith(null) && regex_result > 0) {
            return false;
        }
        else {
            return true;
        }
    }
    def reverse(): String {
        a:String = "ABC";
        result:String = new String(a.size);

        for(i:int = 0; i<a.len; i++) {
            result.buffer[i] = a.buffer[a.len-i-1];
        }
        result.buffer[i] = '\0';

        result.len = a.len;

        return result;
    }
    def insert(index:int, str:String):  String {
        a:String = "ABC";

        if(index < 0) {
            index += a.len + 1;
        }
        if(index < 0) {
            index = 0;
        }
        if(index > a.len) {
            index = a.len;
        }

        len:int = str.length();

        if(a.len+len + 1 < a.size) {
            for(i:int = index; i<a.len; i++) {
                a.buffer[i+len] = a.buffer[i];
            }
            a.buffer[i] = '\0';
            for(i = 0; i<len; i++) {
                a.buffer[index+i] = str.buffer[i];
            }

            a.len += len;
        }
        else {
            new_size:int = (a.len + len + 1) * 2 + 1;
            new_buffer:char[] = new char[new_size];

            for(i:int = 0; i<index; i++) {
                new_buffer[i] = a.buffer[i];
            }
            for(i=0; i<len; i++) {
                new_buffer[i+index] = str.buffer[i];
            }
            for(i=index; i<a.len; i++) {
                new_buffer[i+len] = a.buffer[i];
            }

            new_buffer[i+len] = '\0';

            a.buffer = new_buffer;
            a.size = new_size;

            a.len += len;
        }

        return a;
    }

    def toBuffer():  Buffer throws Exception {
        aaaa:String = "ABC";
        array_:byte[] = null;
        System.wcstombs(&array_, aaaa.buffer);

        result:Buffer = new Buffer(array_.length.to_ulong);
        for(i:int = 0; i<array_.length-1; i++) {
            result.append(array_[i]);
        }

        # no null-terminated Buffer will be returened

        return result;
    }

    def indexOf(regex_:regex, count:int): int throws Exception {
        result:int = -1;
        offset:int = 0;
        count2:int = 0;

        aaaa :String = "ABC";

        buffer:Buffer = aaaa.toBuffer();
        ovec_max:int = 16;
        ovec:PcreOVec = new PcreOVec(ovec_max);

        while(true) {
            regex_result:int = System.pcre_exec(regex_, buffer, offset, ovec_max, ovec);

            ### match ###
            if(regex_result > 0) {
                count2++;
                if(count2 == count) {
                    ovec_result:int = ovec.start[0];

                    if(ovec_result == 0) {
                        result = 0;
                    }
                    else {
                        utf32_offset:int = 0;

                        p:pointer = buffer.buffer;
                        while(p < p + buffer.len) {
                            c:ubyte = p->ubyte;

                            # utf8 character
                            if(c > 127uy) {
                                size:int = ((c & 0x80) >> 7) + ((c & 0x40) >> 6) + ((c & 0x20) >> 5) + ((c & 0x10) >> 4);
                                if(size > System.MB_LEN_MAX) {
                                    throw new Exception("unexpected error at String.indexOf");
                                }
                                else {
                                    p += size.to_ulong;
                                }

                                utf32_offset++;
                            }
                            # ascii
                            else {
                                p++;
                                utf32_offset++;
                            }

                            if(p - buffer.buffer == ovec_result) {
                                break;
                            }
                        }

                        result = utf32_offset;
                    }
                    break;
                }

                if(offset == ovec.end[0]) {
                    offset++;
                }
                else {
                    offset = ovec.end[0];
                }
            }
            ### no match ###
            else {
                break;
            }
        }

        return result;
    }
    def insert2(index:int, item:Integer): EqualableList<Integer> {
        aaa :EqualableList<Integer> = equalable_list { 1, 2, 3 };

        if(index < 0) {
            index += aaa.number + 1;
        }
        if(index < 0) {
            index = 0;
        }
        if(index > aaa.number) {
            index = aaa.number;
        }

        if(aaa.number == 0 || index == aaa.number) {
            aaa.add(item);
            return aaa;
        }

        if(index == 0) {
            new_item:ListItem<Integer> = new ListItem<Integer>(item, null, aaa.head);
            aaa.head.prev = new_item;
            aaa.head = new_item;

            aaa.number++;
        }
        else {
            it:ListItem<Integer> = aaa.head;

            i:int = 0;

            while(!it.identifyWith(null)) {
                if(i == index-1) {
                    new_item:ListItem<Integer> = new ListItem<Integer>(item, it, it.next);
                    if(!it.next.identifyWith(null)) {
                        it.next.prev = new_item;
                    }
                    it.next = new_item;

                    aaa.number++;
                    break;
                }

                it = it.next;
                i++;
            }
        }

        return aaa;
    }
    def add(item:Integer):EqualableList<Integer> {
        aaa:EqualableList<Integer> = equalable_list { 1, 2, 3 };

        if(aaa.head.identifyWith(null)) {
            aaa.head = new ListItem<Integer>(item, null, null);
            aaa.tail = aaa.head;
        }
        else {
            new_item:ListItem<Integer> = new ListItem<Integer>(item, aaa.tail, null);

            aaa.tail.next = new_item;
            aaa.tail = new_item;
        }

        aaa.number++;

        return aaa;
    }
    def subBuffer(start:int, end:int): Buffer {
        aaa:Buffer = b"ABC";
        if(start < 0) {
            start += aaa.len;
        }
        if(end < 0) {
            end += aaa.len.to_int + 1;
        }

        if(start < 0) {
            start = 0;
        }
        if(end > aaa.len) {
            end = aaa.len;
        }

        if(start >= end || start >= aaa.len || end < 0) {
            return B"";
        }

        result: Buffer = new Buffer(end.to_ulong-start.to_ulong);

        System.memcpy(result.buffer, aaa.buffer + start.to_ulong, (end-start).to_ulong);

        result.len = end-start;
        result.size = end-start;

        # no null-terminated buffer will be returned

        return result;
    }
    def scan(regex_:regex): EqualableList<String> {
        aaa:String = "ABC";

        result: EqualableList<String> = new EqualableList<String>();
        offset:int = 0;

        buffer:Buffer = aaa.toBuffer();
        ovec_max:int = 16;
        ovec:PcreOVec = new PcreOVec(ovec_max);

        while(true) {
            regex_result:int = System.pcre_exec(regex_, buffer, offset, ovec_max, ovec);

            ### match and no group strings ###
            if(regex_result == 1) {
                match_string:String = buffer.subBuffer(ovec.start[0], ovec.end[0]).toString();
                result.add(match_string);

                if(offset == ovec.end[0]) {
                    offset++;
                }
                else {
                    offset = ovec.end[0];
                }
            }
            ### group strings ###
            elif(regex_result > 1) {
                match_string:String = buffer.subBuffer(ovec.start[0], ovec.end[0]).toString();
                result.add(match_string);

                if(offset == ovec.end[0]) {
                    offset++;
                }
                else {
                    offset = ovec.end[0];
                }

                for(i:int = 1; i<regex_result; i++) {
                    match_string:String = buffer.subBuffer(ovec.start[i], ovec.end[i]).toString();
                    result.add(match_string);
                }
            }
            ### no match ###
            else {
                break;
            }
        }

        return result;
    }
    def groupName():String {
        aaa:stat = new stat("/bin");
        result:String = "";

        p"/etc/group".read().toString().split(/\n/).each(closure(line:String) {
            fields:EqualableList<String> = line.chomp().split(/:/);
            
            if(fields.items(2).to_int() == aaa.st_gid) {
                result = fields.items(0);
            }
        });

        return result;
    }
    def sub(regex_:regex, replace:String, group_strings:EqualableList<String>):  String {
        aaa:String = "ABC";

        result: String = new String();
        offset:int = 0;

        buffer:Buffer = aaa.toBuffer();
        ovec_max:int = 16;
        ovec:PcreOVec = new PcreOVec(ovec_max);

        while(true) {
            regex_result:int = System.pcre_exec(regex_, buffer, offset, ovec_max, ovec);

            ### match and no group strings ###
            if(regex_result == 1 || group_strings.identifyWith(null) && regex_result > 0) {
                str:String = buffer.subBuffer(offset, ovec.start[0]).toString();
                result.append(str);
                result.append(replace);

                if(offset == ovec.end[0]) {
                    offset++;
                }
                else {
                    offset = ovec.end[0];
                }

                if(!regex_.global) {
                    str:String = buffer.subBuffer(offset, -1).toString();
                    result.append(str);
                    break;
                }
            }
            ### group strings ###
            elif(regex_result > 1) {
                str:String = buffer.subBuffer(offset, ovec.start[0]).toString();
                result.append(str);
                result.append(replace);

                if(offset == ovec.end[0]) {
                    offset++;
                }
                else {
                    offset = ovec.end[0];
                }

                for(i:int = 1; i<regex_result; i++) {
                    match_string:String = buffer.subBuffer(ovec.start[i], ovec.end[i]).toString();
                    group_strings.add(match_string);
                }

                if(!regex_.global) {
                    str:String = buffer.subBuffer(offset, -1).toString();
                    result.append(str);
                    break;
                }
            }
            ### no match ###
            else {
                str:String = buffer.subBuffer(offset, -1).toString();
                result.append(str);
                break;
            }
        }

        return result;
    }
    def buffer_initialize(size:size_t): {
        a:Buffer = new Buffer();
        System.free(a.buffer);
        a.size = size;
        a.buffer = System.malloc(a.size);
        a.len = 0;
    }
    def buffer_initialize2(buf:pointer, size:size_t): {
        a:Buffer = new Buffer();
        System.free(a.buffer);
        a.size = size;
        a.buffer = System.malloc(a.size);
        System.memcpy(a.buffer, buf, size);
        a.len = a.size;
    }

    def run118(): static Buffer {
        array_:byte[] = null;
        System.wcstombs(&array_, "AAA".buffer);

        result:Buffer = new Buffer(array_.length.to_ulong);
        for(i:int = 0; i<array_.length-1; i++) {
            result.append(array_[i]);
        }

        # no null-terminated Buffer will be returened

        return result;
    }
    def items(aaa:Array<Integer>, index:int): Integer throws Exception {
        if(index < 0) {
            index += aaa.items.length;
        }

        return aaa.items[index];
    }

    def toBuffer(aaa:String):  Buffer throws Exception {
        array_:byte[] = null;
        System.wcstombs(&array_, aaa.buffer);

        result:Buffer = new Buffer(array_.length.to_ulong);
        for(i:int = 0; i<array_.length-1; i++) {
            result.append(array_[i]);
        }

        # no null-terminated Buffer will be returened

        return result;
    }
    def split2(aaa:String, separator:regex): EqualableList<String> {
        result:EqualableList<String> = new EqualableList<String>();
        offset:int = 0;

        buffer:Buffer = self.toBuffer(aaa);
        ovec_max:int = 16;
        ovec:PcreOVec = new PcreOVec(ovec_max);

        while(true) {
            regex_result:int = System.pcre_exec(separator, buffer, offset, ovec_max, ovec);

            ### match and no group strings ###
            if(regex_result == 1) {
                str:String = buffer.subBuffer(offset, ovec.start[0]).toString();
                result.add(str);

                if(offset == ovec.end[0]) {
                    offset++;
                }
                else {
                    offset = ovec.end[0];
                }
            }
            ### group strings ###
            elif(regex_result > 1) {
                str:String = buffer.subBuffer(offset, ovec.start[0]).toString();
                result.add(str);

                if(offset == ovec.end[0]) {
                    offset++;
                }
                else {
                    offset = ovec.end[0];
                }

                for(i:int = 1; i<regex_result; i++) {
                    str:String = buffer.subBuffer(ovec.start[i], ovec.end[i]).toString();
                    result.add(str);
                }
            }
            ### no match ###
            else {
                break;
            }
        }

        return result;
    }
    def split(separator:regex): EqualableList<String> {
        aaa:String = "ABC\nDEF";
        result:EqualableList<String> = new EqualableList<String>();
        offset:int = 0;

        buffer:Buffer = aaa.toBuffer();
        ovec_max:int = 16;
        ovec:PcreOVec = new PcreOVec(ovec_max);

        while(true) {
            regex_result:int = System.pcre_exec(separator, buffer, offset, ovec_max, ovec);

            ### match and no group strings ###
            if(regex_result == 1) {
                str:String = buffer.subBuffer(offset, ovec.start[0]).toString();
                result.add(str);

                if(offset == ovec.end[0]) {
                    offset++;
                }
                else {
                    offset = ovec.end[0];
                }
            }
            ### group strings ###
            elif(regex_result > 1) {
                str:String = buffer.subBuffer(offset, ovec.start[0]).toString();
                result.add(str);

                if(offset == ovec.end[0]) {
                    offset++;
                }
                else {
                    offset = ovec.end[0];
                }

                for(i:int = 1; i<regex_result; i++) {
                    str:String = buffer.subBuffer(ovec.start[i], ovec.end[i]).toString();
                    result.add(str);
                }
            }
            ### no match ###
            else {
                break;
            }
        }

        return result;
    }

    def closure_test1():int {
        a: JITTestClassA = new JITTestClassA();

        e:int = 30;
        f:int = 40

        return a.method10(10, 20, closure(x:int, y:int):int {
            return x + y + e + f;
        });
    }
    def closure_test2():int {
        a: JITTestClassA = new JITTestClassA();

        e:int = 30;
        f:int = 10

        a.method10(10, 20, closure(x:int, y:int):int {
            e += f;
        });

        return e;
    }
    def closure_test3(): String {
        result:String = "";

        "ABC\nDEF\nGHI".split(/\n/).each(closure(line:String) {
            result = "ABC";
        });

        return result;
    }
}
